#define _POSIX_SOURCE 1 /* Song length: 47 seconds (30 seconds of loop). */
static char*Title="NES-S3M player for /dev/audio (8-bit, µ-law)\n"
"This file has been compiled from a file created with intgen.";
typedef unsigned char by;char*A,*In,*tmp="nesmusa.$$$",*a0;
static by*z=(by*)"+l=6*mM*JlmZmG\\Q1EE\\\\N_`@ggPQGEm\\lOoI`(g7P1FQRD;_H@7g=P"
"MFm5R*0:OK`(g7PAFeR\\;OI`5g=PMJE*M+l(nm:*BJQ1EE\\\\NO``fgSQ9Ee\\\\OoMJ(Fb*0b"
"d++;K)JXm5*Pm=*RmM*Vmm*Zmm+Jmm)*mm5*lm=*nT5bm:*>QRU)+*5Hl9oN2*b2g]QU)+J9\\l="
"6*0*`c:*Z+Rm9=5(*<<oY`c:*b6Qm)+J(ML<6*NncefYK*J)9mQL<6*<_`m:*RJUU)+*5Ll1oN2*"
"bRf]PU)+J9Pl=6*0NZ`FbJ(BLQU)+*(_l=R*4O:oFbJ(Bf+AEK)0J;5JA7<R*4K`c:*J*Pm)0J;5"
"J5R<*F:O*VKHgYK**+Dm5F*I<*R:S`c:*JJPm)0J;5JDR<JW:O*LFb:*:[+E9K)+*75bZ6<V*Fb`"
"EfYK**+;m5F*L<*nFN2*Rb*D8[K@;K8=5(*30oM:+>`*R:[+0JU)n=F5*Pm=Re+OJmcc*=b[K*ZI"
")BL(58*7<bb0N2+Fb*KQJQm)0J;_L<6*2f`mJ(BfPU)+*(Ql=R*F6bm:*fK\\[)+J+`dg_Qa=bbK"
"*ZJJa+e)lANn:*BJ[OIa4m;<L2*>*c<XOVm5n*=D<L2*>BclXoWm5>(7<:+0RNn:*BJXOWa0m=:4"
"0NJ(Fb*CRZ+n:K)DXm5BSm=JWOSAGeP\\GOQ5NE)(\\4N?b@Zg)\\Q+4E?\\@Ngb`+eg*VQ2E;\\"
"HNoJa@Z+=RVWI15E<\\NOc`XgWQ5ZE)<:+;RNFcRX;WQ0EG\\PNo*l@Z+ebJ)FJ(5N)7<220N*Fl"
"m*:om+*om)Jnm5*LX<Rn0fA^eB][LQoDa_dA_eL]oLm(57<0NFbPZGKQ(E7\\1NEbm+cEKMIm4m?"
"lAoe`]gMQmdm_mam*gQZ+>UH)n](5VM7<Z)0bAfeR];MQlDo_`Age\\]OMm5ZN7P?DA^dB_g@QgD"
"Q_DA]dL_mCIY4U?""<AOd`^gCQYdU_=aEdR^;CIXDW_0AGdP^OCaXlI?L2*:2dm+7:K)+*7Y4=6*"
"2>amJ(RZK*:K)4;(58*7HoYAn:*B*]OLanla?L2*>ReL]oLm65=6*4:NUb<[m)+J(25=6*4JN5c<"
"XmVI5(*)8\\UN=c=f[)+J+:eK\\)oEgbK*:(Gm5F*0<6*0NJ(RRgbK*ZSDm5(*7^?L2*:Zdm+7:K"
")+*75*0=P?L2*VRdm+02T@mb4=6*2JaEebK*:5Om5(*7<:+0VAn:*R9\\m)0*75N)7<*nJL*Fn?Z"
"mK*Bd@ag\\Q?Ea_d@_Y@IglP_Ga`:*>H_Q)2Z0glg_QaDe^\\EOQ`<g?Pa9eT\\Q)+:(`lc_YaTe"
">]ELQn<c?XaIe4]Q)+:(nlm_malen]eMQm<m?laaed]Q)+:(ml=:+9NZ)DZe\\]AMYlLo_`afeR]"
"=MAll=R*3ba`:*F;]1MEl\\nOoa`*(6H]m)D(75n70(\\5n<bNZeJQ+=)<4n1bDZQ)+:>+m=b:9N"
":+:;e][OIe4U?l@NgbS[;IM4e>LO2*\\cbg+6B0Im2e;LIN4c1XGVU25;lKN)cgK*2+Vm5FW6>le"
"N]cOYcT]?EALdN^cEY_TE5(JIBLgnPcGY1UE5:JV@lM2*:;dgK**+CmY\\<6*2>amZ0U:_m)gN5g"
"l=ZNFVa`:*2;\\m)f575(C7<RX0NRN9ZemKH>WNE`\\fOSa@eg+6bT)n*(5R77<R00RamJa`[+cE"
"K)PXB52)7<R*FNJQmb:*RZ+lEK)\\D55T*1ZOWa0eG\\1OE5:JGXoM*19b:(bK^m)+J(Z\\<6*2*"
"aeggK**+Em5*f<<RR1N2*Fb*AHX]Q)+*5ml=RR0NJ89b:(*8]1MEl\\nOoa`*(6H]m)<37566=<B"
"3FN:]Sb*1KX+6^INme\\<6*2Nam*5d[+GLK)+*75nJ9<JP8B@eflSo)+:+U\\;OM2*02gOPc)+*+"
"PTG?Q@DgQPeG]5(J(B_L2*2Rg@QgDQ_<OOL2*2bgcQYEI]4K?""(A6d2^[BI[4Io3a9dU^=CMYlT"
"o?aId4_?@AgdP_GAYdT_?Am5RC0<^0FNZHGb*2QZK*:+NE5(*9ZoMJ8SbJ5RZ^QCEY\\RO;aHd7_"
"mCEY\\To5a`:*J:^mCE5(*3<b+F>am:*RZ+L:K)+J(5*c9<N(RN*SSb*:g9]Q)+J6ol=*FFNJ(`*"
"em+L:K)dL55`*FloMJ;FbJI=[K3*WJm5FJ<<V7_2n8bWZQ)2*8(moNO2*VZY=RQ)+J6Jl=6*R2a`"
":*JJ^m)RP(52E7<bVLN*oS2egK*:HNm5:+0<Jc3N2+FJe]]Q)+*(ll+",
o[256],w[256][64],NN[8],s[5][65536],l[299999],
sn[32]="Moon by NESMusa";
#include <stdio.h>
#include <unistd.h>
static int ss,m,IN,IV[99],IP[256],PP[100],b,M,I,D[99],Bxx,Cxx,B,Ss,CP,
At[256][64],Np=0,S=SEEK_SET,h,OF,PN,d,p=1,r,k,i,a,c,CO,j,x,T=336,f=8000,LS=0,
P[12],H[99],IL[99];FILE*fo,*fi=stdin;
#define rw(a) a=fgetc(fi),a|=fgetc(fi)<<8
static int Out(int v){int e=0,s=1,f=0;if(OF)v=128+v/30;else for((s=(v<0))?v=-v
:0;e<8;e++)if((f=((v+32)>>(e+1))-16)<16)break;return fputc(OF?v:~((s<<7)|(e<<4
)|f),fo);}void gn(void){for(f=0;A[1]>='0'&&A[1]<='9';f=f*10+*++A-'0');}int
G(int n){while((k=1<<n)>p)d+=p*(by)((*z++^134)+84),p*=64;PN=d&(k-1);d/=k,p/=k;
return PN;}int main(int C,char**V){
if(V)a0=*V;for(P[CO=a=i=C?0:(fseek(fo,0,SEEK_END),r=ftell(fo)/8,rewind(fo),
fread(l,8,r,fo),fclose(fo),remove(tmp),z=(by*)In,main(-1,0))]=907;++i<12;P[i
]=P[i-1]*89/84);if(C<0){if(isatty(fileno(fo=stdout)))fo=fopen(A=OF?"/dev/dsp":
"/dev/audio","wb");if(!fo){perror(A);exit(-1);}a=c=i=sn[29]=0;
for(fprintf(stderr,"Playing %s (%s)...\n",*z-'*'?z:z+1,sn);;
i<3?i++:((c?c--^Out(S/9):++a>=r?a=LS:(c=f*5/T)),i=S=0)){
x=l[a*8+4+i],j=i?i-1:0;H[i] += (D[j]?D[j]*P[x%12]/14500:P[x%12])<<x/12;
if(IL[j])S += (s[j][((unsigned)H[i]/f)%IL[j]]-128)*l[a*8+i];}}
while(--C)if(*(A=*++V)-'-')In=A;else if(A[1])while(*A&&A[1])
*++A=='r'?gn(),0:*A=='d'?OF=1:*A=='h'?h=1:0;else In="*stdin";
if(!In){fprintf(stderr,"%s\n\nUsage:\t %s [options] nesfile.s3m\n"
"Example: %s mman3_d2.s3m\n\t %s -dr22050 cv2b.s3m|esdcat "
"-b -m -r 22050\nOptions:\n"
"\t -d\tPlay in linear format instead & use /dev/dsp if not piped\n"
"\t -r#\tSelect sampling rate in Hz\n\t -h\tThis help\n\n",Title,a0,a0,a0);
if(h)exit(0);for(r=3210,LS=1130,c=4;c--;)for(a=0;a<r;)if((S=G(7))-7)
l[c+8*a+4]=S,l[c+8*a++]=G(6)^63;else for(i=G(10),S=G(8);S--;a++)
l[a*8+4+c]=l[(a-i)*8+4+c],l[a*8+c]=l[(a-i)*8+c];
for(i=IL[0]=IL[1]=32;--i>=0;s[0][i]=(i&24)?170:20)s[1][i]=16*(i<16?i:31-i);
for(i=IL[2]=999;--i>=0;s[2][i]=(a=a*999+1)%200);z=(by*)"built-in song";
main(i,0);}if(*In-'*')fi=fopen(In,"rb");if(!fi||!(fo=fopen(tmp,"wb+")))
{perror(fi?tmp:In);return-1;}fread(sn,1,32,fi);rw(m);rw(IN);
rw(PN);fseek(fi,49,S);x=fgetc(fi);T=fgetc(fi)*2;fseek(fi,0x60,S);
fread(o,m,1,fi);for(i=0;i<IN;i++)rw(IP[i]);for(i=0;i<PN;i++)rw(PP[i]);
for(i=0;i<IN;i++)fseek(fi,IP[i]*16+13,S),fgetc(fi),rw(LS),rw(IL[i]),rw(j),
fseek(fi,8,SEEK_CUR),IV[i]=fgetc(fi),fseek(fi,3,SEEK_CUR),
rw(D[i]),fseek(fi,LS*16,S),fread(s[i],1,IL[i],fi);
for(;;){if(CO>=m)main(0,V);if((CP=o[CO])-254){fseek(fi,PP[CP]*16,S);
rw(i);if(!i)PP[CP]=0;if(PP[CP])fread(z=s[4],i-=2,1,fi);for(r=0;r<64;r++){if(!r)ss=1;
a?0:w[CO][r]?(LS=At[CO][r]),main(0,V):(At[CO][r]=ftell(fo)/8,(w[CO][r]=1));
Bxx=Cxx=-1,Ss=ss,j=B=ss=0;if(PP[CP])while((b=*z++)-(M=I=0)){
if(b&32){if(!a){if(*z<254)NN[(b&3)+4]=*z%16+12*(*z/16);else
if(*z==254)NN[b&3]=0;if(z[1]&&*z!=254)NN[b&3]=IV[z[1]-1];}z+=2;}
if(b&64){if(!a)NN[b&3]=*z;z++;}if(b&128){M=*z++;I=*z++;}
if(M==1&&!a)x=I;M==2?Bxx=I:M==3?Cxx=I:M==4?ss=1:0;
if(M==19){if(I/16==11)*((B=I&15)?&ss:&Ss)=1;if(I/16==14)j=I&15;}}if(a)
a--;else{if(Ss)Np=ftell(fo);for(i=(j+1)*x;i;i--)fwrite(NN,1,8,fo);
if(B){c=ftell(fo)-Np;fseek(fo,Np,S);fread(l,1,c,fo);
fseek(fo,Np+c,S);for(i=B;i;i--)fwrite(l,1,c,fo);}
if(Bxx>=0){CO=Bxx-1;if(Cxx<0)break;}
if(Cxx>=0){a=(Cxx&15)+10*(Cxx/16);break;}}}}CO++;}}
