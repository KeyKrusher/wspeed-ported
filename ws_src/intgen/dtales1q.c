#define _POSIX_SOURCE 1
static char*Title="NES-S3M player for /dev/audio (8-bit, µ-law)\n"
"This file has been compiled from a file created with intgen.";
typedef unsigned char by;char*A,*In,*tmp="nesmusa.$$$",*N;
static by*z=(by*)"b'<oa'PTa: 5 H3FF:;3>N4^X47_F6;;8>04@]XI7QFB[n>kK^]4I'R&L;P"
"TnAc]XI7QFB;o>VKD]8I'R&L;h9n1XA0a <oaU1>N4TXX7WFF;;=>J4DX87'<Sb]iTk165ccn3ck"
"'PTQ: 5aK <c3'PTY% 5a= <cM PTA  5aG<l%HVaU4IH5baWm&H;jDaAL] 7G3oaE3>@?aAcAG3"
"oa9a= JH5baWW&<;jDa1j_ Zlak%:jDaALP OG3oa91= KH5baH_&HVaIAHH5baW%%X;jDaALS K"
"G3oaES>@?aAcZ6WkM^bYG4H5bam[&H^bY]_>LcZ^aoN>?JQ_nARZBDkM^bYmKH5bamQ&H^bY]_9b"
"]ZbkQNnMb^_YJcZ^aoNnQb^_SIcZ^aoNn[b^_5m]ZJI]M&LKQ_0UnZ\\<kM>M$R_P0cZ^a%Mn9RR"
"?aanZ2S]MFC4Q_KUnZ^aoNnUc^_akZZbk H>T8S_ii]ZBDGM61JQ_mZcZ\\akM>2JQ?mAcZjEkMn"
"=G]_%PkZRbIMn $RA 5bAW=VOVaYA7FF$;'lWOVaYQ1&A$b VWOVaYA2FL$o RWOVaYa3FM$i <;"
"b%Y:Y?aAbT8X70%P4RQB5]an]WOVaYA3FN$k <So]iTnQB5Mbn3Ch]i4N9 55M <CN;S8K7^F4;_"
"<;7Ui9[1>A4bX<;7U19K2^L4oX<;7Ua:k3^M4iX<;7Ui4hIMNLThXW7EF:;3>N4Z2XoMNcmB3RNL"
"kh^7KE^:K3>59Tl3;oWiTnQB57bn3ki]iTI9 5aN <cI'PTi$ 5AR333W^I8Y02GL&_$6?D68[0&"
"G$&'nWkE]9I1^B4cXn7kEX971 5a]n'V'D%890>@4 _ 6'D 8'0 5]]n3CVJiTP^B5Q^n33l]18I"
"0R@L'_&6;D>8K0F@$''<CX^I?Y62[L>_46_D6?[6&[$>'HVWDE?95>Z4<_H6WD@?'5@ZL3oNVkD^"
"?K5^Z43?N6T$P?Y?aac2'<Ka]iDaACZLZlaiU$P4cQB5ban3[mSiDcQBY %o<oaUA8W0FG &o<oa"
"UI8G0&G mh<oaUA9W2FC ZlakMn 4Q325balS7HEP:P=25balA7lFh;0K25baj]&H^bQR?aAcZJa"
"]=[UDa1J_ ZlakYDUDaabD Z^akMVaQR_ACh>o<oaMI?@_kQU>'2VOVaAa7@FLZla;I$PDaQB5]a"
"n3VOVaI\\7 5kak3;o]iTA  5a'0c%HVaUD6&[8>O4&_D6?Z62[@>?KFNVaUC645iA^K&4DX867Z"
"F0;_>FKD]8H7VFXZlajI$H8W0DG<%G:63$M8i0PGD%73oaSA8 0&@8 O &'D&8:02@@ ?'FNVaM1"
"0 5]Aj3;b_1870D@<'G&6;$=8I0P@D''<KaS18^?aQn&7%F:$38>045iAQ%&H>SQR_@bnb8lGhEW"
"9D1>AHbhl'nET9^?aQUb <;QOi4canF o8VGDE?942^LHohV'ZE<9^?a1Vh03CaO39P3FM8iHR'C"
"En:j3RM@i8QGNVaMa3 5KCmU'8E0:F<:O0VXDG?E5:X<6OXZlah2%K:^<4OXW03CaSK:@?aak373"
"oaQQ? 545bamO&HFNNQ6 5>5WK&HN:QR745baj3&HN'QR?QOcZ^ZkM6ENA0 5nJ]3FJ$S8N74FXZ"
"Ra8MNhAQ_[BcZ^nkI$P4$3L53Pn3KkoTTZQB5kak33>'iDaQB5SSn3;[;i$m1cEX:73FN$S8^_m1"
"k:'<CNSiDc1lZ Zlaka$kDaabY 773oaQ1>@?[TjZZ5mMVaIQ_?mkZ<4]Mn=KQ_nNcZ<4_MN2K\\"
"_GknZnmGM>SQR_LknZZjIMnb>R7 DXZlaiE$PThKL5K5n3oaIi4h9M5IkjU6D[ =G?aQbH7RFHVa"
"]QK$]<ZlamI[_>5KZ^0KGX&OVa]a4>5bac[6?[6>[4\\XHZlam%;%>:42XL1oBVcDm?Y52YL2'M&"
"j$\\?H50Z@<'O&RDL?o66[D>?K6ZD<?O6 5=Uk37kIiTKXB53Gn3oa]a8^?aAj9'<;RJi4hQBZX<"
"7OFR$C?n6T[ <7OFV$P?^?aac2'<;_\\iDcQB5GakO&HVaIQ_GAcZlakMnMFS?\\akZR[]MnI=\\"
"045baj;&HnIQR_kQh9'<3l]i464L5Fa]'&HNRIQ_<DhZ$aGm%P4cIL5ZB_mGj%S9^_maSc &ENVa"
"iBH@QXZlaSa;PDaaN5K_n3CK]iTG^B5__P3C JiT\\5L5=?P3[Z^a",o[256],w[256][64],
n[8],s[5][65536],l[299999],sn[50]="The 6000-byte moon theme (Duck Tales)";
#include <stdio.h>
#include <unistd.h>
static int ss,m,IN,q[99],g[256],e[100],b,M,I,D[99],Bxx,Cxx,B,Ss,CP,hb,
Q[256][64],Np=0,S=SEEK_SET,h,u,PN,d,p=1,r,k,i,a,c,CO,j,x,T=336,f=8000,LS=0,
P[12],H[99],IL[99];FILE*fo,*fi=stdin;
#define rw(a) a=fgetc(fi),a|=fgetc(fi)<<8
static int Out(int v){int e=0,s=1,f=0;if(u)v=128+v/30;else for((s=(v<0))?v=-v
:0;e<8;e++)if((f=((v+32)>>(e+1))-16)<16)break;return fputc(u?v:255^((s<<7)|(e
<<4)|f),fo);}void gn(void){for(f=0;A[1]>='0'&&A[1]<='9';f=f*10+*++A-'0');}int
G(int n){while((k=1<<n)>p)d += p*(by)((*z++^116)-21),p*=64;PN=d&(k-1);d/=k,
p/=k;return PN;}int main(int C,char**V){if(V)N=*V;for(P[CO=a=i=C?0:(fseek(fo,
0,SEEK_END),r=ftell(fo)/8,rewind(fo),fread(l,8,r,fo),fclose(fo),remove(tmp),z=
(by*)In,main(-1,0))]=907;++i<12;P[i]=P[i-1]*89/84);if(C<0){if(isatty(fileno(fo
=stdout)))fo=fopen(A=u?"/dev/dsp":"/dev/audio","wb");if(!fo){perror(A);
exit(-1);}a=c=i=sn[49]=0;
for(fprintf(stderr,"Playing %s (%s) (%d seconds, %d%% loop)\n",
*z-'*'?z:z+1,sn,r*5/T,100-LS*100/r)
;;i<3?i++:((++c<f*5/T?Out(S/9):++a>=r?a=LS:(c=0)),i=S=0))
{x=l[a*8+4+i],j=i?i-1:0;
H[i]=(x&128&&hb&&!c)?0:(x&=127,H[i]+((D[j]?D[j]*P[x%12]/14500:P[x%12])<<x/12));
if(IL[j])S += (s[j][((unsigned)H[i]/f)%IL[j]]-128)*l[a*8+i];}}
while(--C)if(*(A=*++V)-'-')In=A;else if(A[1])while(*A&&A[1])*++A==
'r'?gn(),0:*A=='d'?u=1:*A=='t'?hb=1:*A=='h'?h=1:0;else In="*stdin";
if(!In)
{	fprintf(stderr,"%s\n\nUsage:\t %s [options] nesfile.s3m\n"
	"Example: %s mman3_d2.s3m\n"
	"\t %s -dr44100 cv2b.s3m|esdcat -b -m\nOptions:\n"
	"\t -t\tEnable retrigger mode\n"
	"\t -d\tPlay in linear format & use /dev/dsp if not piped\n"
	"\t -r#\tSelect sampling rate in Hz\n\n",Title,N,N,N);
	if(h)exit(0);
	for(r=3210,LS=1130,c=4;c--;)for(a=0;a<r;)if((S=G(7))-89)
		l[c+8*a+4]=S,l[c+8*a++]=G(6)^63;else for(i=G(11),S=G(8);S--;a++)
		l[a*8+4+c]=l[(a-i)*8+4+c],l[a*8+c]=l[(a-i)*8+c];
	for(i=IL[0]=IL[1]=32;--i>=0;
		s[0][i]=(i&24)?200:24)s[1][i]=12*(i<16?i:31-i);
	for(i=IL[2]=999;--i>=0;s[2][i]=(a=a*999+1)%230);
	z=(by*)"built-in song";main(i,0);}
if(*In-'*')fi=fopen(In,"rb");if(!fi||!(fo=fopen(tmp,"wb+")))
{perror(fi?tmp:In);return-1;}fread(sn,1,32,fi);rw(m);rw(IN);
rw(PN);fseek(fi,49,S);x=fgetc(fi);T=fgetc(fi)*2;fseek(fi,0x60,S);
fread(o,m,1,fi);for(i=0;i<IN;i++)rw(g[i]);for(i=0;i<PN;i++)rw(e[i]);
for(i=0;i<IN;i++)fseek(fi,g[i]*16+13,S),fgetc(fi),rw(LS),rw(IL[i]),rw(j),
fseek(fi,8,SEEK_CUR),q[i]=fgetc(fi),fseek(fi,3,SEEK_CUR),
rw(D[i]),fseek(fi,LS*16,S),fread(s[i],1,IL[i],fi);
for(;;){if(CO>=m)main(0,V);if((CP=o[CO])-254){fseek(fi,e[CP]*16,S);rw(i);
	if(!i)e[CP]=0;if(e[CP])fread(z=s[4],i-=2,1,fi);for(r=0;r<64;r++){
	if(!r)ss=1;a?0:w[CO][r]
	?	(LS=Q[CO][r]),main(0,V)
	:	(Q[CO][r]=ftell(fo)/8,(w[CO][r]=1));
	Bxx=Cxx=-1,Ss=ss,j=B=ss=0;
	if(e[CP])
	while((b=*z++)-(M=I=0))
	{if(b&32){if(!a){if(*z<254)n[(b&3)+4]=*z%16+12*(*z/16)+128;else
	if(*z==254)n[b&3]=0;if(z[1]&&*z!=254)n[b&3]=q[z[1]-1];}z+=2;}
	if(b&64){if(!a)n[b&3]=*z;z++;}if(b&128){M=*z++;I=*z++;}
	if(M==1&&!a)x=I;M==2?Bxx=I:M==3?Cxx=I:M==4?ss=1:0;
	if(M==19){if(I/16==11)*((B=I&15)?&ss:&Ss)=1;if(I/16==14)j=I&15;}}
	if(a)a--;else
	{	if(Ss)Np=ftell(fo);for(i=(j+1)*x;i;i--){fwrite(n,1,8,fo);for(b=4;b<8;n[b++]&=127);}
		if(B){c=ftell(fo)-Np;fseek(fo,Np,S);fread(l,1,c,fo);fseek(fo,Np+c,S);
		for(i=B;i;i--)fwrite(l,1,c,fo);}if(Bxx>=0){CO=Bxx-1;if(Cxx<0)break;}
		if(Cxx>=0){a=(Cxx&15)+10*(Cxx/16);break;}}
}}CO++;}}
